<!-- Notification Bell Icon in Navbar -->
<div class="notification-container">
    <!-- Bell Icon -->
    <button class="btn btn-icon btn-outline-secondary position-relative" id="notificationBell" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Notifications">
        <i class="fas fa-bell"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
            <span id="unreadCount">0</span>
        </span>
    </button>

    <!-- Dropdown Menu -->
    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationBell" style="width: 400px; max-height: 600px; overflow-y: auto; z-index: 9999;">
        <!-- Header -->
        <div class="dropdown-header d-flex justify-content-between align-items-center border-bottom">
            <strong><i class="fas fa-bell me-2"></i>Notifications</strong>
            <button class="btn btn-sm btn-link text-muted" id="markAllRead" title="Marquer tout comme lu">
                <i class="fas fa-check-double"></i>
            </button>
        </div>

        <!-- Notifications List -->
        <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fs-4 mb-2 d-block"></i>
                <small>Chargement...</small>
            </div>
        </div>

        <!-- Footer -->
        <div class="dropdown-footer text-center border-top p-2">
            <a href="@Url.Action("Index", "Notifications")" class="text-primary text-decoration-none small d-block py-2">
                <i class="fas fa-list me-1"></i>Voir toutes les notifications
            </a>
        </div>
    </div>
</div>

<style>
    .notification-container { 
        position: relative; 
    }
    
    .notification-item { 
        padding: 12px 15px; 
        border-bottom: 1px solid #f0f0f0; 
        cursor: pointer; 
        transition: background-color 0.2s;
        display: flex;
        gap: 10px;
    }
    
    .notification-item:hover { 
        background-color: #f8f9fa; 
    }
    
    .notification-item:last-child {
        border-bottom: none;
    }
    
    .notification-item.unread { 
        background-color: #e7f3ff; 
        border-left: 3px solid #667eea; 
        padding-left: 12px;
    }
    
    .notification-time { 
        font-size: 0.80rem; 
        color: #999; 
        margin-top: 4px;
    }
    
    .notification-icon { 
        width: 40px; 
        height: 40px; 
        min-width: 40px;
        border-radius: 50%; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: white; 
        font-size: 1rem; 
        flex-shrink: 0;
    }
    
    .notification-icon.primary { background-color: #667eea; }
    .notification-icon.success { background-color: #28a745; }
    .notification-icon.warning { background-color: #ffc107; color: #333; }
    .notification-icon.danger { background-color: #dc3545; }
    .notification-icon.info { background-color: #17a2b8; }
    
    .notification-content {
        flex: 1;
        min-width: 0;
    }
    
    .notification-title {
        font-weight: 600;
        margin: 0;
        color: #333;
        font-size: 0.95rem;
    }
    
    .notification-message {
        font-size: 0.85rem;
        color: #666;
        margin: 4px 0 0 0;
        line-height: 1.3;
    }
    
    .notification-close {
        flex-shrink: 0;
        align-self: flex-start;
        margin-top: -2px;
    }
    
    .dropdown-menu {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .dropdown-footer {
        background-color: #f8f9fa;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Utiliser la fonction partagée pour marquer tout comme lu
    const markBtn = document.getElementById('markAllRead');
    if (markBtn) {
        markBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fetch('/api/notifications/read-all', { method: 'POST' })
                .catch(err => console.error('Mark all:', err))
                .finally(() => loadNotificationsShared());
        });
    }
    
    // Déléguer les clics sur les notifications
    document.addEventListener('click', function(e) {
        const item = e.target.closest('.notification-item');
        if (item) {
            const id = item.dataset.id, url = item.dataset.action;
            fetch(`/api/notifications/${id}/read`, { method: 'POST' }).catch(err => console.error('Mark:', err));
            if (url && url !== '#') window.location.href = url;
        }
    });
});
</script>
