@model GestionArticles.Models.Orders.Order

@{
    ViewData["Title"] = $"Détails Commande #{Model.Id}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid py-4">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-receipt me-2"></i>Commande #@Model.Id</h2>
            <p class="text-muted">@Model.OrderDate.ToString("dddd dd MMMM yyyy à HH:mm", System.Globalization.CultureInfo.CreateSpecificCulture("fr-FR"))</p>
        </div>
        <div class="col-md-4 text-end">
            <a asp-action="Print" asp-route-id="@Model.Id" class="btn btn-outline-secondary" target="_blank">
                <i class="fas fa-print me-1"></i>Imprimer
            </a>
            <a asp-action="MyOrders" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i>Retour
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Colonne Gauche: Informations -->
        <div class="col-lg-4">
            <!-- Statut de Commande -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <strong><i class="fas fa-tasks me-2"></i>Statut de Commande</strong>
                </div>
                <div class="card-body">
                    <!-- Tracker visuel -->
                    <div class="order-tracker mb-4">
                        <div class="steps">
                            @{ 
                                var orderedStatuses = new[] { 
                                    GestionArticles.Models.Orders.OrderStatus.Processing,
                                    GestionArticles.Models.Orders.OrderStatus.Paid,
                                    GestionArticles.Models.Orders.OrderStatus.Preparing,
                                    GestionArticles.Models.Orders.OrderStatus.Shipping,
                                    GestionArticles.Models.Orders.OrderStatus.Delivered
                                }; 
                                var currentIndex = Array.IndexOf(orderedStatuses, Model.Status); 
                                var progressPercent = currentIndex < 0 ? 0 : ((currentIndex + 1.0) / orderedStatuses.Length) * 100; 
                            }
                            <div class="progress-fill" style="width:@progressPercent%"></div>
                            @for (int i = 0; i < orderedStatuses.Length; i++)
                            {
                                var status = orderedStatuses[i];
                                var isActive = i <= currentIndex && currentIndex>=0;
                                var isCurrent = i == currentIndex;
                                <div class="step-wrapper">
                                    <div class="step @(isActive ? "active" : "") @(isCurrent ? "current" : "")">
                                        @if (isActive)
                                        { <i class="fas fa-check"></i> }
                                        else { <span class="step-index">@(i+1)</span> }
                                    </div>
                                    <div class="step-label small">
                                        @switch(status)
                                        {
                                            case GestionArticles.Models.Orders.OrderStatus.Processing:
                                                <span>Traitement</span>
                                                break;
                                            case GestionArticles.Models.Orders.OrderStatus.Paid:
                                                <span>Payée</span>
                                                break;
                                            case GestionArticles.Models.Orders.OrderStatus.Preparing:
                                                <span>Préparation</span>
                                                break;
                                            case GestionArticles.Models.Orders.OrderStatus.Shipping:
                                                <span>Expédition</span>
                                                break;
                                            case GestionArticles.Models.Orders.OrderStatus.Delivered:
                                                <span>Livrée</span>
                                                break;
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Badge Statut -->
                    <div>
                        @switch(Model.Status)
                        {
                            case GestionArticles.Models.Orders.OrderStatus.Processing:
                                <span class="badge bg-warning text-dark fs-6">
                                    <i class="fas fa-hourglass-half me-1"></i>En traitement
                                </span>
                                break;
                            case GestionArticles.Models.Orders.OrderStatus.Paid:
                                <span class="badge bg-primary text-white fs-6">
                                    <i class="fas fa-credit-card me-1"></i>Payée
                                </span>
                                break;
                            case GestionArticles.Models.Orders.OrderStatus.Preparing:
                                <span class="badge bg-info text-white fs-6">
                                    <i class="fas fa-box me-1"></i>En préparation
                                </span>
                                break;
                            case GestionArticles.Models.Orders.OrderStatus.Shipping:
                                <span class="badge bg-primary fs-6">
                                    <i class="fas fa-truck me-1"></i>En expédition
                                </span>
                                break;
                            case GestionArticles.Models.Orders.OrderStatus.Delivered:
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check-circle me-1"></i>Livrée
                                </span>
                                break;
                            case GestionArticles.Models.Orders.OrderStatus.Confirmed:
                                <span class="badge bg-success fs-6">
                                    <i class="fas fa-check-double me-1"></i>Confirmée
                                </span>
                                break;
                        }
                    </div>
                </div>
            </div>

            <!-- Informations Client -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <strong><i class="fas fa-user me-2"></i>Informations Client</strong>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Nom:</dt>
                        <dd class="col-sm-7">@Model.CustomerName</dd>

                        <dt class="col-sm-5">Prénom:</dt>
                        <dd class="col-sm-7">@Model.FirstName @Model.LastName</dd>

                        <dt class="col-sm-5">Email:</dt>
                        <dd class="col-sm-7"><a href="mailto:@Model.Email">@Model.Email</a></dd>

                        <dt class="col-sm-5">Téléphone:</dt>
                        <dd class="col-sm-7">@Model.Phone</dd>

                        <dt class="col-sm-5">Adresse:</dt>
                        <dd class="col-sm-7">@Model.Address</dd>
                    </dl>
                </div>
            </div>

            <!-- Méthode de Paiement -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <strong><i class="fas fa-credit-card me-2"></i>Paiement</strong>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Méthode:</strong>
                        @if (Model.PaymentMethod == "COD")
                        {
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-money-bill me-1"></i>Paiement à la Livraison
                            </span>
                        }
                        else if (Model.PaymentMethod == "CARD")
                        {
                            <span class="badge bg-success">
                                <i class="fas fa-credit-card me-1"></i>Carte Bancaire
                            </span>
                        }
                    </p>
                </div>
            </div>
        </div>

        <!-- Colonne Droite: Produits et Montants -->
        <div class="col-lg-8">
            <!-- Articles Commandés -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <strong><i class="fas fa-box me-2"></i>Articles Commandés (@Model.Items.Count)</strong>
                </div>
                <div class="card-body">
                    @if (Model.Items != null && Model.Items.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Produit</th>
                                        <th class="text-center">Quantité</th>
                                        <th class="text-end">Prix Unitaire</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.Items)
                                    {
                                        var itemTotal = item.Quantity * item.Price;
                                        <tr>
                                            <td>
                                                <strong>@item.ProductName</strong>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-light text-dark">@item.Quantity</span>
                                            </td>
                                            <td class="text-end">
                                                @item.Price.ToString("F2") €
                                            </td>
                                            <td class="text-end">
                                                <strong>@itemTotal.ToString("F2") €</strong>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Aucun article dans cette commande.
                        </div>
                    }
                </div>
            </div>

            <!-- Résumé Montants -->
            <div class="card shadow-sm border-primary">
                <div class="card-header bg-primary text-white">
                    <strong><i class="fas fa-calculator me-2"></i>Résumé Montants</strong>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col">
                            <p class="mb-2">Sous-total (articles):</p>
                        </div>
                        <div class="col-auto">
                            <p class="mb-2 text-end">
                                <strong>@((Model.Items?.Sum(i => i.Quantity * i.Price) ?? 0).ToString("F2")) €</strong>
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col">
                            <p class="mb-2">Frais de livraison:</p>
                        </div>
                        <div class="col-auto">
                            <p class="mb-2 text-end">
                                <strong>@Model.DeliveryFee.ToString("F2") €</strong>
                            </p>
                        </div>
                    </div>

                    <div class="border-top pt-3">
                        <div class="row">
                            <div class="col">
                                <h5 class="mb-0">Total à payer:</h5>
                            </div>
                            <div class="col-auto">
                                <h5 class="mb-0 text-success">@Model.TotalAmount.ToString("F2") €</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .order-tracker { padding: 1rem 0; }
    .steps {
        position:relative;
    }
    .progress-fill{
        position:absolute;
        top:30px;
        left:0;
        height:2px;
        background:#667eea;
        border-radius:2px;
        z-index:1;
        transition:width .4s ease
    }
    .step{
        position:relative
    }
    .step-index{
        font-size:.9rem;
        font-weight:600;
        color:#667eea
    }
    .step.current{
        border:3px solid #4ECDC4;
    }
    .step.current:not(.active){
        background:#fff
    }

    .step-label {
        margin-top: 0.75rem; 
        font-size: 0.85rem;
        font-weight: 500;
        text-transform: uppercase;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9ff !important;
    }
</style>
