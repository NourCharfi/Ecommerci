@model IEnumerable<GestionArticles.Models.Product>
@{
    ViewData["Title"] = "Gestion des produits";
    var categories = ViewData["Categories"] as IEnumerable<GestionArticles.Models.Category> ?? Enumerable.Empty<GestionArticles.Models.Category>();
}

<h2>Gestion des produits</h2>
<div class="mb-3 d-flex gap-2 align-items-center">
    <a class="btn btn-success" asp-action="Create">+ Nouveau produit</a>
    <div class="ms-auto d-flex gap-2 align-items-center">
        <label class="me-2 mb-0">Filtrer par catégorie :</label>
        <select id="filterCategory" class="form-select" style="width:220px;">
            <option value="">Toutes</option>
            @foreach(var c in categories)
            {
                <option value="@c.CategoryName">@c.CategoryName</option>
            }
        </select>
    </div>
</div>

<!-- ? Ajout classe 'datatable' pour initialisation globale -->
<table id="productsTable" class="table table-striped table-bordered datatable" style="width:100%">
    <thead>
        <tr>
            <th>Image</th>
            <th>ID</th>
            <th>Nom</th>
            <th>Catégorie</th>
            <th>Prix</th>
            <th>Stock</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach(var p in Model)
        {
            <tr>
                <td style="width:80px; text-align:center;">
                    @if (!string.IsNullOrEmpty(p.Image))
                    {
                        <img src="~/images/@p.Image" style="height:50px; width:50px; object-fit:cover; border-radius:4px;" />
                    }
                    else
                    {
                        <img src="~/images/noimage.jpg" style="height:50px; width:50px; object-fit:cover; border-radius:4px;" />
                    }
                </td>
                <td>@p.ProductId</td>
                <td>@p.Name</td>
                <td>@p.Category?.CategoryName</td>
                <td>@p.Price.ToString("C0")</td>
                <td>@p.QteStock</td>
                <td>
                    <a class="btn btn-sm btn-info me-1" asp-action="Details" asp-route-id="@p.ProductId">Détails</a>
                    <a class="btn btn-sm btn-primary me-1" asp-action="Edit" asp-route-id="@p.ProductId">Modifier</a>
                    <form asp-action="Delete" method="post" style="display:inline-block;" onsubmit="return confirm('Supprimer ce produit ?');">
                        <input type="hidden" name="id" value="@p.ProductId" />
                        <button type="submit" class="btn btn-sm btn-danger">Supprimer</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        // ? Gestion du filtre par catégorie (compatible avec initialisation globale DataTables)
        document.addEventListener('DOMContentLoaded', function() {
            const filterButton = document.getElementById('filterCategory');
            if (filterButton) {
                filterButton.addEventListener('change', function() {
                    const categoryFilter = $(this).val() || '';
                    // Attendre que DataTables soit initialisé (max 500ms)
                    let attempts = 0;
                    const checkInterval = setInterval(function() {
                        if ($.fn.DataTable.isDataTable('#productsTable')) {
                            const table = $('#productsTable').DataTable();
                            // Column index: 3 (Catégorie)
                            table.column(3).search(categoryFilter).draw();
                            clearInterval(checkInterval);
                        }
                        attempts++;
                        if (attempts > 10) clearInterval(checkInterval); // 500ms max
                    }, 50);
                });
            }
        });
    </script>
}
